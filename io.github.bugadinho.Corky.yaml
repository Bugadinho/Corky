app-id: io.github.bugadinho.Corky
runtime: org.kde.Platform
runtime-version: '6.5'
sdk: org.kde.Sdk
base: com.riverbankcomputing.PyQt.BaseApp
base-version: '6.5'
command: cork

cleanup-commands:
  - /app/cleanup-BaseApp.sh
  - mkdir -p /app/share/steam/compatibilitytools.d

build-options:
  env:
    - BASEAPP_REMOVE_WEBENGINE=1

finish-args:
  - --share=network
  - --socket=x11
  - --share=ipc
  - --allow=devel
  - --socket=pulseaudio
  - --device=all
  - --env=PYTHONPATH=/app

add-extensions:
  com.valvesoftware.Steam.CompatibilityTool:
    subdirectories: true
    directory: share/steam/compatibilitytools.d
    version: stable
    versions: stable;beta;test
    no-autodownload: true
    autodelete: false

modules:
  - python3-requirements.yaml

  - name: proton
    buildsystem: simple
    build-options:
      strip: false
      no-debuginfo: true
    build-commands:
      - mkdir -p /app/proton
      - tar -C /app/proton --strip-components 1 -xvf proton.tar.gz --skip-old-files --delay-directory-restore --absolute-names
    sources:
      - type: file
        dest-filename: proton.tar.gz
        url: https://github.com/GloriousEggroll/proton-ge-custom/releases/download/GE-Proton8-13/GE-Proton8-13.tar.gz
        sha256: 5dd21061b5aa04589dadc59a0316ed91680a0b61b908548f35a9888649bf9eaa
  
  - name: cork
    buildsystem: simple
    build-commands:
      - install -Dm755 cork_executable /app/bin/cork
      - mv -v cork /app
      - mv -v default.json /app/cork
      - install -Dm644 resources/roblox-player.desktop /app/share/applications/roblox-player.desktop
      - install -Dm644 resources/roblox-studio.desktop /app/share/applications/roblox-studio.desktop
      - install -Dm644 resources/cork.svg /app/share/icons/hicolor/scalable/apps/cork.svg
      - install -Dm644 resources/roblox-player.svg /app/share/icons/hicolor/scalable/apps/roblox-player.svg
      - install -Dm644 resources/roblox-studio.svg /app/share/icons/hicolor/scalable/apps/roblox-studio.svg
    post-install:
      - mv -v /app/share/applications/roblox-player.desktop /app/share/applications/${FLATPAK_ID}.robloxplayer.desktop
      - mv -v /app/share/applications/roblox-studio.desktop /app/share/applications/${FLATPAK_ID}.robloxstudio.desktop
      - desktop-file-edit /app/share/applications/${FLATPAK_ID}.robloxplayer.desktop
        --set-icon=${FLATPAK_ID}.robloxplayer --set-key=StartupWMClass --set-value='steam_app_robloxplayer'
      - desktop-file-edit /app/share/applications/${FLATPAK_ID}.robloxstudio.desktop
        --set-icon=${FLATPAK_ID}.robloxstudio --set-key=StartupWMClass --set-value='steam_app_robloxstudio'
      - cp -v /app/share/icons/hicolor/scalable/apps/cork.svg -T /app/share/icons/hicolor/scalable/apps/${FLATPAK_ID}.svg
      - cp -v /app/share/icons/hicolor/scalable/apps/roblox-player.svg -T /app/share/icons/hicolor/scalable/apps/${FLATPAK_ID}.robloxplayer.svg
      - cp -v /app/share/icons/hicolor/scalable/apps/roblox-studio.svg -T /app/share/icons/hicolor/scalable/apps/${FLATPAK_ID}.robloxstudio.svg
    sources:
      - type: git
        url: https://github.com/Bugadinho/Cork.git
        commit: 728d4b1e1ba8c90db87af01f65650828ff8bd827
        x-data-checker:
          is-main-source: true
          type: git
          tag-pattern: ^v([\d.]+)$
      - type: file
        path: cork_executable
      - type: file
        path: default.json
